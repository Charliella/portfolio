<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LIFE_TREE // 生命之樹：故事接龍終端</title>
    <link href="https://fonts.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --neon-green: #00ff88;
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-yellow: #ffee00;
            --neon-red: #ff0055; 
            --bg-dark: #020202;
            --tree-brown: #5c3b1a;
            --text-main: #e0e0e0;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            font-family: 'Share Tech Mono', monospace;
            color: var(--neon-green);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- Header & Navigation --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 30px; position: fixed; top: 0; left: 0; width: 100%;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem; margin: 0;
            color: var(--neon-green);
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.6);
            letter-spacing: 2px;
        }
        
        .header-controls { display: flex; gap: 10px; align-items: center; }

        .header-btn {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(0, 255, 136, 0.3);
            padding: 8px 15px; cursor: pointer; font-family: 'Share Tech Mono';
            transition: all 0.3s; font-size: 0.8rem;
            display: flex; align-items: center; gap: 6px; border-radius: 4px;
            color: var(--neon-green);
        }

        .page-switch-btn.active {
            background: var(--neon-green);
            color: #000;
        }

        .admin-logged-in .login-btn { display: none !important; }

        /* --- Shared Content Styles --- */
        #pageContainer { padding-top: 60px; min-height: 100vh; position: relative; }
        .page-content-wrapper { display: none; padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%; }
        .story-section-title { font-family: 'Orbitron'; color: var(--neon-pink); margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid rgba(255, 0, 255, 0.2); padding-bottom: 5px; font-size: 1.2rem; width: 100%; }

        /* --- 1. 故事樹區域 --- */
        #treePage { display: flex; flex-direction: column; align-items: center; }
        #fullStoryNarrative { background: rgba(0, 243, 255, 0.1); border: 2px solid var(--neon-blue); padding: 20px; margin-bottom: 30px; font-size: 1.1rem; line-height: 1.6; color: var(--text-main); border-radius: 5px; max-width: 800px; width: 100%; white-space: pre-wrap; max-height: 300px; overflow-y: auto; box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); }
        #treeVisualization { position: relative; width: 100%; max-width: 800px; min-height: 50vh; padding-bottom: 100px; margin-top: 20px; }
        .tree-trunk { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 30px; height: 100%; background: linear-gradient(to top, var(--tree-brown) 50%, #333); border-radius: 15px 15px 0 0; z-index: 10; }
        .tree-node-content { background: rgba(0, 255, 136, 0.1); border: 1px solid var(--neon-green); border-radius: 10px; padding: 15px; max-width: 400px; margin: 0 auto; position: relative; font-size: 1rem; line-height: 1.4; color: var(--text-main); box-shadow: 0 0 15px rgba(0, 255, 136, 0.3); pointer-events: auto; cursor: pointer; text-align: left; padding-top: 40px; }
        #initialPromptNode { padding-top: 35px; }
        
        /* --- 2. 接龍區域 --- */
        .current-story-prompt { background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon-blue); padding: 15px; margin-bottom: 20px; font-size: 1rem; line-height: 1.5; color: var(--text-main); border-radius: 5px; white-space: pre-wrap; }
        #terminalCommentsContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        
        .terminal-comment-card { 
            background: rgba(20, 20, 25, 0.6); 
            border-left: 3px solid var(--neon-blue); 
            padding: 15px; 
            color: var(--text-main); 
            border-radius: 4px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); 
            position: relative; 
            padding-top: 40px; 
            display: flex;
            flex-direction: column;
        }

        .terminal-comment-card .comment-content {
            max-height: 150px; 
            overflow-y: auto;  
            line-height: 1.5;
            margin-bottom: 10px;
            padding-right: 5px;
        }
        
        .input-dock { display: flex; flex-wrap: wrap; gap: 15px; max-width: 800px; margin: 20px auto 40px auto; align-items: flex-start; padding: 20px; background: rgba(10, 10, 12, 0.5); border: 1px solid rgba(0, 255, 136, 0.2); border-radius: 8px; }
        .dock-input { background: #000; border: 1px solid var(--neon-green); color: var(--neon-green); padding: 12px; font-family: 'Share Tech Mono'; font-size: 1.1rem; box-shadow: 0 0 5px rgba(0, 255, 136, 0.5); transition: all 0.3s; }
        #usernameInput { width: 100px; order: 1; }
        #messageInput { flex-grow: 1; min-height: 120px; resize: vertical; order: 2; min-width: 250px; }
        .send-btn { width: 100%; max-width: 120px; height: 48px; background: var(--neon-green); border: none; color: #000; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 5px; font-size: 1.1rem; order: 3; }
        @media (min-width: 600px) {
            #usernameInput { flex-basis: 100px; }
            #messageInput { flex-basis: calc(100% - 100px - 15px - 120px); }
            .send-btn { width: 120px; align-self: stretch; flex-shrink: 0; }
        }

        /* --- 3. 管理者介面 --- */
        .admin-dashboard { 
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .admin-panel {
            background: rgba(10, 10, 20, 0.7);
            border: 1px solid var(--neon-blue);
            padding: 20px;
            border-radius: 8px;
        }
        .admin-action-btn-lg {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            font-size: 1rem;
            cursor: pointer;
            border: 1px solid;
            background: rgba(0,0,0,0.3);
            color: var(--neon-blue);
        }
        .admin-panel textarea {
            width: 100%;
            height: 150px;
            background: #000;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            padding: 10px;
            margin-bottom: 10px;
        }

        /* --- Admin Controls on Nodes (Common) --- */
        .admin-controls-card { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; opacity: 0; transition: opacity 0.3s; z-index: 40; }
        .admin-logged-in .terminal-comment-card .admin-controls-card,
        .admin-logged-in .tree-node-content .admin-controls-card,
        .admin-logged-in #initialPromptNode .admin-controls-card { opacity: 1; }
        
        .admin-action-btn { background: rgba(0,0,0,0.5); color: var(--text-main); border: 1px solid rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 0.75rem; }
        .admin-select-btn { background: var(--neon-blue); color: #000; border-color: var(--neon-blue); }
        .admin-edit-btn { color: var(--neon-yellow); border-color: var(--neon-yellow); }
        .admin-delete-btn { color: var(--neon-red); border-color: var(--neon-red); }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 50000;
            backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center;
        }
        .modal-box {
            background: var(--bg-dark); border: 3px solid var(--neon-pink); border-radius: 8px;
            padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 0 20px var(--neon-pink);
            position: relative; text-align: center; color: var(--text-main);
        }
        .modal-input { width: 100%; padding: 10px; margin-bottom: 15px; background: #000; border: 1px solid var(--neon-green); color: var(--neon-green); font-size: 1rem; }
        .modal-btn { background: var(--neon-pink); color: #000; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .close-modal { position: absolute; top: 10px; right: 15px; color: #fff; cursor: pointer; font-size: 1.2rem; }
    </style>
</head>
<body>

    <header>
        <h1><i class="fa-solid fa-tree"></i> LIFE_TREE // 故事之樹</h1>
        <div class="header-controls">
            
            <div class="header-btn page-switch-btn active" id="switchTreeBtn" data-target="treePage" title="Main Story View">
                <i class="fa-solid fa-scroll"></i> 故事樹
            </div>
            <div class="header-btn page-switch-btn" id="switchTerminalBtn" data-target="terminalPage" title="Student Submission Terminal">
                <i class="fa-solid fa-comments"></i> 接龍區
            </div>
            <div class="header-btn page-switch-btn" id="switchAdminBtn" data-target="adminPage" style="display:none;" title="Admin Dashboard">
                <i class="fa-solid fa-user-gear"></i> 管理者介面
            </div>
            
            <div class="header-btn login-btn" id="loginTrigger" title="Admin Login">
                <i class="fa-solid fa-user-lock"></i> 管理員登入
            </div>
            <div class="header-btn login-btn" id="logoutTrigger" style="display:none;" title="Logout">
                <i class="fa-solid fa-right-from-bracket"></i> 登出
            </div>
        </div>
    </header>

    <div id="pageContainer">
        
        <div id="treePage" class="page-content-wrapper" style="display: flex;">
            <h2 class="story-section-title"><i class="fa-solid fa-book"></i> 當前完整故事主線</h2>
            <div id="fullStoryNarrative">CONNECTING...</div>

            <h2 class="story-section-title"><i class="fa-solid fa-scroll"></i> 故事樹成長紀錄 (正史節點視覺化)</h2>
            <div id="treeVisualization">
                <div class="tree-trunk"></div>
                <div id="initialPromptNode" title="The genesis of the narrative.">
                    <div class="admin-controls-card">
                        <button class="admin-action-btn admin-edit-btn" data-node-id="INIT" title="Edit Root Prompt">
                            <i class="fa-solid fa-pencil"></i> 編輯
                        </button>
                    </div>
                    STORY ROOT
                </div> 
            </div>
        </div>

        <div id="terminalPage" class="page-content-wrapper">
            <h2 class="story-section-title"><i class="fa-solid fa-book-open"></i> 最新故事接續提示</h2>
            <div class="current-story-prompt" id="terminalStoryPrompt">CONNECTING TO MAIN STORY...</div>

            <h2 class="story-section-title"><i class="fa-solid fa-shuffle"></i> 待選情節 (接龍留言)</h2>
            <div id="terminalCommentsContainer">
                </div>

            <h2 class="story-section-title"><i class="fa-solid fa-pen-nib"></i> 情節提交區</h2>
            <div class="input-dock">
                <input type="text" id="usernameInput" class="dock-input" placeholder="座號* (E.g. 01)" maxlength="2" pattern="\d{1,2}" title="Enter your 1 or 2 digit seat number.">
                <textarea id="messageInput" class="dock-input" placeholder="接續故事的情節 (最多 500 字)..." maxlength="500"></textarea>
                <button class="send-btn" id="sendBtn" title="Submit Plot"><i class="fa-solid fa-paper-plane"></i> 提交</button>
            </div>
        </div>
        
        <div id="adminPage" class="page-content-wrapper">
            <h2 class="story-section-title" style="color:var(--neon-yellow);"><i class="fa-solid fa-user-gear"></i> 管理者操作儀表板 (獨立介面)</h2>

            <div class="admin-dashboard">
                
                <div class="admin-panel" style="border-color:var(--neon-blue);">
                    <h3>主線故事及根節點設定</h3>
                    <p style="font-size:0.85rem; color:#ccc;">在此編輯整個故事的起點或修訂完整敘事。</p>
                    <textarea id="adminStoryContentInput" placeholder="請輸入完整的新的故事內容..."></textarea>
                    <button class="admin-action-btn-lg" id="adminSaveStoryBtn" style="color:var(--neon-blue);">
                        <i class="fa-solid fa-floppy-disk"></i> 更新完整故事敘事
                    </button>
                </div>

                <div class="admin-panel" style="border-color:var(--neon-red);">
                    <h3>危險區域：系統維護</h3>
                    <p style="font-size:0.85rem; color:var(--neon-red);">這些操作不可逆轉，請謹慎使用。</p>
                    <button class="admin-action-btn-lg" id="adminDownloadTrigger" style="color:var(--neon-yellow);">
                        <i class="fa-solid fa-file-export"></i> 下載所有紀錄 (LOGS)
                    </button>
                    <button class="admin-action-btn-lg" id="adminPurgeTrigger" style="color:var(--neon-red);">
                        <i class="fa-solid fa-trash-can"></i> 清除所有資料並重啟系統
                    </button>
                </div>
                
                <div class="admin-panel" style="border-color:var(--neon-pink);">
                    <h3>所有節點狀態總覽 (待開發)</h3>
                    <p style="font-size:0.85rem; color:var(--neon-pink);">未來將在此處提供所有節點的篩選與批次管理功能。</p>
                    <p style="font-size:0.85rem; color:#666;">目前節點管理請回「故事樹」或「接龍區」進行操作。</p>
                </div>

            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="loginModal">
        <div class="modal-box">
            <h3 class="modal-title">系統驗證 (ADMIN)</h3>
            <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">需要管理員憑證才能操作。</p>
            <input type="email" id="adminEmail" class="modal-input" placeholder="操作員 ID (EMAIL)">
            <input type="password" id="adminPassword" class="modal-input" placeholder="存取碼">
            <button class="modal-btn" id="loginBtn">認證</button>
            <div class="close-modal" id="closeLoginModal">取消</div>
        </div>
    </div>

    <div class="modal-overlay" id="editNodeModal">
        <div class="modal-box">
            <h3 class="modal-title" style="color:var(--neon-yellow);">編輯情節節點</h3>
            <p style="font-size:0.8rem; color:var(--neon-yellow); margin-bottom:15px;">修正情節的內容和座號。</p>
            
            <label for="editNodeStudentIdInput" style="display:block; text-align:left; font-size:0.9rem; margin-bottom:5px; color:#fff;">座號 (1-2位數字):</label>
            <input type="text" id="editNodeStudentIdInput" class="modal-input" placeholder="座號" maxlength="2" pattern="\d{1,2}" title="Enter 1 or 2 digit seat number.">
            
            <label for="editNodeContentInput" style="display:block; text-align:left; font-size:0.9rem; margin-bottom:5px; color:#fff;">情節內容 (Max 500 字):</label>
            <textarea id="editNodeContentInput" class="modal-input" placeholder="請輸入修正後的情節內容... (最多 500 字)" maxlength="500"></textarea>
            
            <button class="modal-btn" id="saveNodeBtn" style="background:var(--neon-yellow); color:#000;">儲存修改</button>
            <div class="close-modal" id="closeEditNodeModal">取消</div>
        </div>
    </div>
    
    <div class="modal-overlay" id="canonicalSelectModal">
        <div class="modal-box">
            <h3 class="modal-title">確認納入正史</h3>
            <p style="font-size:0.8rem; color:var(--neon-yellow); margin-bottom:15px;">確認將此情節納入故事正史？</p>
            <div id="selectedNodeContent" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:5px; margin-bottom:20px; text-align:left; font-size:0.9rem;"></div>
            <button class="modal-btn" id="confirmCanonicalBtn">合併並更新故事</button>
            <div class="close-modal" id="closeCanonicalSelectModal">取消</div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDocs, writeBatch, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, updateDoc } 
               from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // ⚠️ 必讀：請將此處的設定替換為您自己的 Firebase 專案配置
        const firebaseConfig = {
            apiKey: "AIzaSyArIXMKMd1zLVVgcNn8KdUNbv3XEZxA1OQ",
            authDomain: "teachinportfolio-1f100.firebaseapp.com",
            projectId: "teachinportfolio-1f100",
            storageBucket: "teachinportfolio-1f100.firebasestorage.app",
            messagingSenderId: "367006551150",
            appId: "1:367006551150:web:d8bb677fa08de192beea7f",
            measurementId: "G-PMLXDSYL28"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); 
        const db = getFirestore(app);

        // --- State ---
        let currentMainStoryId = "INIT"; 
        let currentMainStoryContent = "CONNECTING..."; 
        let allNodesData = []; 
        let selectedCanonicalNode = null; 
        
        // --- Elements ---
        const pageContainer = document.getElementById('pageContainer');
        const fullStoryNarrative = document.getElementById('fullStoryNarrative'); 
        const terminalStoryPrompt = document.getElementById('terminalStoryPrompt');
        const terminalCommentsContainer = document.getElementById('terminalCommentsContainer');
        const treeVisualization = document.getElementById('treeVisualization');

        const adminStoryContentInput = document.getElementById('adminStoryContentInput');
        const adminSaveStoryBtn = document.getElementById('adminSaveStoryBtn');
        const adminDownloadTrigger = document.getElementById('adminDownloadTrigger');
        const adminPurgeTrigger = document.getElementById('adminPurgeTrigger');

        const nodesCollectionRef = collection(db, "story_nodes");

        // --- Utility Functions ---
        function formatTime(timestamp) {
            if (!timestamp) return "..:..";
            const date = timestamp.toDate();
            return (date.getMonth()+1) + "/" + date.getDate() + " " + 
                   String(date.getHours()).padStart(2, '0') + ":" + 
                   String(date.getMinutes()).padStart(2, '0');
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page-content-wrapper').forEach(p => p.style.display = 'none');
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = (pageId === 'treePage') ? 'flex' : 'block';
            }
            document.querySelectorAll('.page-switch-btn').forEach(btn => {
                if (btn.dataset.target === pageId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            if (pageId === 'adminPage') {
                adminStoryContentInput.value = currentMainStoryContent;
            }
        }
        
        function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        
        function getLastSentence(text) {
            const lines = text.trim().split(/[\n]/g).filter(line => line.trim() !== '');
            if (lines.length > 0) {
                return lines[lines.length - 1];
            }
            return text;
        }

        // --- Core Functions: Download Logs (修正：確保按鈕狀態獨立) ---
        async function adminDownloadLogs(btnElement) {
            if (!auth.currentUser) {
                alert("下載紀錄需要管理員權限。");
                return;
            }
            
            const originalText = btnElement.innerHTML;
            const isMerging = btnElement.id === 'confirmCanonicalBtn';
            if (!isMerging) {
                btnElement.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> 下載中...";
            }
            
            try {
                const allNodesQuery = query(nodesCollectionRef, orderBy("timestamp", "asc"));
                const snapshot = await getDocs(allNodesQuery);
                
                const now = new Date().toLocaleString();
                let logContent = `=== LIFE_TREE 完整紀錄 ===\n時間: ${now}\n\n`;
                logContent += `--- 完整故事主線 ---\n${currentMainStoryContent}\n\n`;
                logContent += `--- 所有節點資料 ---\n`;
                
                snapshot.forEach((doc) => {
                    const item = doc.data();
                    const status = item.is_canonical ? '正史' : '支線';
                    const parent = item.parent_id ? item.parent_id.substring(0, 4) : 'N/A';
                    const id = doc.id.substring(0, 4);
                    
                    logContent += `[ID:${id}][父節點:${parent}][狀態:${status}][座號:#S${item.student_id}][${formatTime(item.timestamp)}]: ${item.content}\n`;
                });
                
                const blob = new Blob([logContent], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `STORY_LOG_${new Date().getTime()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                if (!isMerging) alert("完整紀錄已匯出。");
                return true; // 下載成功
            } catch (error) {
                alert("匯出紀錄失敗: " + error.message);
                return false; // 下載失敗
            } finally {
                if (!isMerging) {
                    btnElement.innerHTML = originalText;
                }
            }
        }

        // --- Event Listeners: Navigation & Modals ---
        
        // 頁面切換 (沒問題)
        document.querySelectorAll('.page-switch-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetId = e.currentTarget.dataset.target;
                if (targetId === 'adminPage' && !auth.currentUser) {
                    alert("請先登入管理員權限。");
                    openLoginModal();
                    return;
                }
                switchPage(targetId);
            });
        });
        
        document.getElementById('loginTrigger').addEventListener('click', openLoginModal);
        document.getElementById('logoutTrigger').addEventListener('click', async () => { await signOut(auth); });
        
        document.getElementById('closeLoginModal').addEventListener('click', () => closeModal('loginModal'));
        document.getElementById('closeCanonicalSelectModal').addEventListener('click', () => { closeModal('canonicalSelectModal'); selectedCanonicalNode = null; });
        document.getElementById('closeEditNodeModal').addEventListener('click', () => { closeModal('editNodeModal'); document.getElementById('editNodeModal').dataset.nodeId = ''; });

        switchPage('treePage'); 
        
        // --- Data Listeners (沒問題) ---
        onSnapshot(doc(db, "settings", "main_story"), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                currentMainStoryContent = data.content || "NO INITIAL PROMPT SET.";
                currentMainStoryId = data.last_node_id || "INIT";
                fullStoryNarrative.innerText = currentMainStoryContent;
                terminalStoryPrompt.innerText = getLastSentence(currentMainStoryContent) || currentMainStoryContent; 
            } else {
                setDoc(doc(db, "settings", "main_story"), {
                    content: "The system awaits the initial prompt...",
                    last_node_id: "INIT",
                    updated_at: serverTimestamp()
                }, { merge: true });
            }
        });
        
        const qAll = query(nodesCollectionRef, orderBy("timestamp", "asc"));
        onSnapshot(qAll, (snapshot) => {
            allNodesData = []; 
            snapshot.forEach((doc) => {
                const data = doc.data();
                data.id = doc.id;
                data.timestampStr = formatTime(data.timestamp);
                allNodesData.push(data);
            });
            renderTreeVisualization(allNodesData);
            renderTerminalComments(allNodesData);
        });

        onAuthStateChanged(auth, (user) => {
            const logoutTrigger = document.getElementById('logoutTrigger');
            const loginTrigger = document.getElementById('loginTrigger');
            const switchAdminBtn = document.getElementById('switchAdminBtn');

            if (user) {
                pageContainer.classList.add('admin-logged-in');
                switchAdminBtn.style.display = 'flex';
                logoutTrigger.style.display = 'flex'; 
                loginTrigger.style.display = 'none'; 
            } else {
                pageContainer.classList.remove('admin-logged-in');
                switchAdminBtn.style.display = 'none';
                logoutTrigger.style.display = 'none'; 
                loginTrigger.style.display = 'flex'; 
                
                if (document.getElementById('adminPage').style.display !== 'none') {
                    switchPage('treePage');
                }
            }
            // 重新呼叫渲染函式，確保按鈕狀態根據登入狀態更新
            renderTreeVisualization(allNodesData); 
            renderTerminalComments(allNodesData);
        });

        // --- Rendering Logic (修正：確保事件綁定在動態元素上) ---
        function renderTreeVisualization(nodes) {
            document.querySelectorAll('.tree-node').forEach(n => n.remove());
            const canonicalNodes = nodes.filter(n => n.is_canonical).sort((a, b) => a.timestamp - b.timestamp);
            const treeHeight = Math.max(50, (canonicalNodes.length + 1) * 15); 
            treeVisualization.style.minHeight = treeHeight + 'vh'; 
            
            // ROOT NODE 編輯按鈕 (靜態，沒問題)
            const initEditBtn = document.querySelector('#initialPromptNode .admin-edit-btn');
            if(initEditBtn) { // 增加判空檢查
                initEditBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (!auth.currentUser) return openLoginModal();
                    switchPage('adminPage'); 
                };
            }
            
            canonicalNodes.forEach((node, index) => {
                const div = document.createElement('div');
                div.className = 'tree-node';
                const totalNodes = canonicalNodes.length + 1; 
                const positionY = ((index + 1) / totalNodes) * 90; 
                div.style.bottom = positionY + '%';
                div.style.opacity = 1; 
                const offset = (index % 2 === 0 ? 150 : -150); 
                div.style.left = `calc(50% + ${offset}px)`;
                div.style.transform = `translateX(-50%)`;

                div.innerHTML = `
                    <div class="tree-node-content" title="Click to view full entry.">
                        <div class="admin-controls-card">
                            <button class="admin-action-btn admin-edit-btn" data-node-id="${node.id}" title="Edit Canonical Node">
                                <i class="fa-solid fa-pencil"></i> 編輯
                            </button>
                            <button class="admin-action-btn admin-delete-btn" data-node-id="${node.id}" title="Revert to Candidate Branch">
                                <i class="fa-solid fa-trash-can"></i> 刪除(回退)
                            </button>
                        </div>
                        <i class="fa-solid fa-seedling" style="color: var(--neon-green); margin-right: 5px;"></i>
                        NODE ${index + 1}: ${node.content.substring(0, 50)}...
                        <span class="node-meta">BY #S${node.student_id} | ${node.timestampStr}</span>
                    </div>
                `;
                
                // 綁定事件 (動態，沒問題)
                div.querySelector('.admin-edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!auth.currentUser) return openLoginModal();
                    openEditNodeModal(node);
                });
                
                div.querySelector('.admin-delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!auth.currentUser) return openLoginModal();
                    deleteNode(node.id, node.student_id, true); 
                });

                treeVisualization.appendChild(div);
            });
        }
        
        function renderTerminalComments(nodes) {
            terminalCommentsContainer.innerHTML = '';
            
            const candidateNodes = nodes.filter(n => !n.is_canonical && n.parent_id === currentMainStoryId).sort((a, b) => b.timestamp - a.timestamp);
            
            if (candidateNodes.length === 0) {
                terminalCommentsContainer.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">尚無待選情節。請在下方提交第一個接續。</p>';
                return;
            }

            candidateNodes.forEach(node => {
                const div = document.createElement('div');
                div.className = 'terminal-comment-card canonical-candidate';
                
                div.innerHTML = `
                    <div class="admin-controls-card">
                        <button class="admin-action-btn admin-select-btn" data-node-id="${node.id}" title="Select as Canonical">
                            <i class="fa-solid fa-check-double"></i> 納入正史
                        </button>
                        <button class="admin-action-btn admin-edit-btn" data-node-id="${node.id}" title="Edit Node">
                            <i class="fa-solid fa-pencil"></i> 編輯
                        </button>
                        <button class="admin-action-btn admin-delete-btn" data-node-id="${node.id}" title="Delete Node">
                            <i class="fa-solid fa-trash-can"></i> 刪除
                        </button>
                    </div>
                    <div class="comment-content">${node.content.replace(/</g, "&lt;")}</div>
                    <div class="comment-meta">
                        <span class="author">座號 #${node.student_id}</span>
                        <span class="time">${node.timestampStr}</span>
                    </div>
                `;
                
                // 綁定事件 (動態，沒問題)
                div.querySelector('.admin-select-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!auth.currentUser) return openLoginModal();
                    selectedCanonicalNode = node;
                    openCanonicalSelectModal(node);
                });

                div.querySelector('.admin-edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!auth.currentUser) return openLoginModal();
                    openEditNodeModal(node);
                });
                
                div.querySelector('.admin-delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!auth.currentUser) return openLoginModal();
                    deleteNode(node.id, node.student_id, false);
                });

                terminalCommentsContainer.appendChild(div);
            });
        }

        // --- Student Submission (沒問題) ---
        document.getElementById('sendBtn').addEventListener('click', async () => {
            const studentID = document.getElementById('usernameInput').value.trim();
            const content = document.getElementById('messageInput').value.trim();

            if (!/^\d{1,2}$/.test(studentID)) {
                alert("錯誤：請輸入 1-2 位數字座號");
                document.getElementById('usernameInput').focus();
                return;
            }

            if (content.length > 500 || content.length === 0) {
                alert("錯誤：情節長度需介於 1-500 字之間");
                return;
            } 

            const originalIcon = document.getElementById('sendBtn').innerHTML;
            document.getElementById('sendBtn').innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> 提交";
            document.getElementById('sendBtn').disabled = true;

            try {
                await addDoc(nodesCollectionRef, {
                    student_id: studentID, 
                    content: content,
                    parent_id: currentMainStoryId, 
                    is_canonical: false,
                    timestamp: serverTimestamp()
                });
                document.getElementById('messageInput').value = ""; 
            } catch (error) {
                console.error("Upload failed", error);
                alert("上傳失敗: " + error.message);
            } finally {
                document.getElementById('sendBtn').innerHTML = originalIcon;
                document.getElementById('sendBtn').disabled = false;
            }
        });


        // --- Admin Actions ---
        
        // 1. 管理者登入 (沒問題)
        function openLoginModal() {
            openModal('loginModal');
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminEmail').focus();
        }
        
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            if(!email || !password) return;

            const originalText = document.getElementById('loginBtn').innerText;
            document.getElementById('loginBtn').innerText = "驗證中...";
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeModal('loginModal');
                alert("管理員權限已授予。");
            } catch (error) {
                alert("認證失敗: " + error.message);
                document.getElementById('adminPassword').value = '';
            } finally {
                document.getElementById('loginBtn').innerText = originalText;
            }
        });


        // 2. 編輯主線故事 (AdminPage 專屬, 沒問題)
        adminSaveStoryBtn.addEventListener('click', async () => {
            if (!auth.currentUser) return alert("需要重新認證。");
            
            const newContent = adminStoryContentInput.value.trim();
            if (!newContent) return alert("故事內容不可為空。");

            const originalText = adminSaveStoryBtn.innerText;
            adminSaveStoryBtn.innerText = "更新中...";
            
            try {
                const mainStoryRef = doc(db, "settings", "main_story");
                await setDoc(mainStoryRef, {
                    content: newContent,
                    updated_at: serverTimestamp()
                }, { merge: true }); 
                
                alert("完整故事敘事更新成功。");
            } catch (error) {
                alert("更新失敗: " + error.message);
            } finally {
                adminSaveStoryBtn.innerText = originalText;
            }
        });
        
        // 3. 納入正史 (Select Canonical)
        function openCanonicalSelectModal(node) {
            openModal('canonicalSelectModal');
            document.getElementById('selectedNodeContent').innerHTML = `
                <div style="color:var(--neon-blue); font-size:0.85rem; margin-bottom:5px;">
                    座號 #${node.student_id} (${node.timestampStr})
                </div>
                ${node.content.replace(/</g, "&lt;")}
            `;
        }

        document.getElementById('confirmCanonicalBtn').addEventListener('click', async () => {
            if (!auth.currentUser || !selectedCanonicalNode) return;
            
            const node = selectedCanonicalNode;
            const btn = document.getElementById('confirmCanonicalBtn');
            const originalText = btn.innerText;
            
            // 詢問是否下載紀錄
            if (confirm("在納入正史前，您是否要先下載完整的紀錄 Log 檔案？")) {
                btn.innerHTML = "<i class='fa-solid fa-download'></i> 準備合併..."; // 顯示正在準備
                // 呼叫下載邏輯 (如果下載成功，程式碼會繼續執行)
                await adminDownloadLogs(btn); 
            }
            
            // 進入合併邏輯
            btn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> 合併中...";
            btn.disabled = true;

            try {
                const batch = writeBatch(db);
                const mainStoryRef = doc(db, "settings", "main_story");
                const selectedNodeRef = doc(nodesCollectionRef, node.id);
                
                const newMainContent = currentMainStoryContent + 
                                       `\n\n[正史節點 by S${node.student_id} @ ${node.timestampStr}]\n` + 
                                       node.content;
                
                batch.set(mainStoryRef, {
                    content: newMainContent,
                    last_node_id: node.id,
                    updated_at: serverTimestamp()
                }, { merge: true });

                batch.update(selectedNodeRef, {
                    is_canonical: true,
                });
                
                await batch.commit();
                
                closeModal('canonicalSelectModal');
                selectedCanonicalNode = null;
                alert("正史支線已合併。故事樹已更新。");
                switchPage('treePage');
            } catch (error) {
                alert("合併失敗: " + error.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });


        // 4. 編輯節點 (Edit Node, 沒問題)
        function openEditNodeModal(node) {
            if (!auth.currentUser) return openLoginModal();
            document.getElementById('editNodeModal').dataset.nodeId = node.id;
            document.getElementById('editNodeStudentIdInput').value = node.student_id;
            document.getElementById('editNodeContentInput').value = node.content;
            openModal('editNodeModal');
            document.getElementById('editNodeContentInput').focus();
        }

        document.getElementById('saveNodeBtn').addEventListener('click', async () => {
            const nodeId = document.getElementById('editNodeModal').dataset.nodeId;
            if (!auth.currentUser || !nodeId) return;
            
            const newStudentId = document.getElementById('editNodeStudentIdInput').value.trim();
            const newContent = document.getElementById('editNodeContentInput').value.trim();

            if (!/^\d{1,2}$/.test(newStudentId)) { alert("錯誤：座號格式不正確。"); return; }
            if (newContent.length > 500 || newContent.length === 0) { alert("錯誤：情節長度需介於 1-500 字之間"); return; } 
            
            const originalText = document.getElementById('saveNodeBtn').innerText;
            document.getElementById('saveNodeBtn').innerText = "儲存中...";
            document.getElementById('saveNodeBtn').disabled = true;

            try {
                const nodeRef = doc(nodesCollectionRef, nodeId);
                await updateDoc(nodeRef, { student_id: newStudentId, content: newContent });
                
                closeModal('editNodeModal');
                alert("情節節點修改成功。");
            } catch (error) {
                alert("修改失敗: " + error.message);
            } finally {
                document.getElementById('saveNodeBtn').innerText = originalText;
                document.getElementById('saveNodeBtn').disabled = false;
            }
        });
        
        // 5. 刪除節點 (Delete Node, 沒問題)
        async function deleteNode(nodeId, studentId, isCanonical) {
            if (!auth.currentUser) return openLoginModal();
            
            let message = isCanonical ? 
                `系統警告：確定要「回退」這則正史節點 (座號 #${studentId}) 嗎？\n\n⚠️ 它將會從故事樹上消失，並回到待選區，且您必須進入「管理者介面」手動修正「完整故事敘事」內容，以確保故事連貫性。` : 
                `確定要永久刪除 座號 #${studentId} 的這則情節留言嗎?`;

            if (!confirm(message)) { return; }
            
            try {
                if (isCanonical) {
                    await updateDoc(doc(db, "story_nodes", nodeId), { is_canonical: false, });
                    alert("正史節點已成功回退為待選支線。請立即前往管理者介面修正主線故事內容。");
                } else {
                    await deleteDoc(doc(db, "story_nodes", nodeId));
                    alert("情節已永久刪除。");
                }
            } catch (error) {
                alert("操作失敗: " + error.message);
            }
        }
        
        // 6. 下載紀錄 (AdminPage 專屬, 沒問題)
        adminDownloadTrigger.addEventListener('click', async () => {
            if (!auth.currentUser) return openLoginModal();
            await adminDownloadLogs(adminDownloadTrigger);
        });

        // 7. 清除資料 (AdminPage 專屬, 沒問題)
        adminPurgeTrigger.addEventListener('click', async () => {
            if (!auth.currentUser) return openLoginModal();
            if (!confirm("系統警告：確定刪除所有故事資料並重新啟動？此操作不可逆轉！")) { return; }
            
            const originalText = adminPurgeTrigger.innerHTML;
            adminPurgeTrigger.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> 清除中...";
            
            try {
                const querySnapshot = await getDocs(nodesCollectionRef);
                const batch = writeBatch(db);
                querySnapshot.forEach((document) => batch.delete(document.ref));
                
                const topicRef = doc(db, "settings", "main_story");
                batch.set(topicRef, {
                    content: "系統已重新啟動。等待初始故事設定。",
                    last_node_id: "INIT",
                    updated_at: serverTimestamp()
                });
                await batch.commit();
                
                await signOut(auth);
                alert("清除完成。系統已重啟。");
                switchPage('treePage');
            } catch (error) {
                alert("清除失敗: " + error.message);
            } finally {
                adminPurgeTrigger.innerHTML = originalText;
            }
        });

    </script>
</body>
</html>