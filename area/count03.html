<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°å°åº—é•·ï¼šæ•¸å­—æ¨™ç±¤å¤§æˆ° v4</title>
    <style>
        :root {
            --sky-blue: #3498db;
            --gold: #f1c40f;
            --green: #2ecc71;
            --red: #e74c3c;
            --bg: #1a1a1a;
            --panel: #2d2d2d;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { 
            height: 100dvh; width: 100vw; margin: 0; padding: 0; 
            overflow: hidden; background-color: var(--bg);
            font-family: system-ui, -apple-system, sans-serif;
            color: #fff;
        }

        .app-container {
            display: flex;
            height: 100dvh;
            padding: 10px;
            gap: 10px;
        }

        .game-main {
            flex: 1;
            display: grid;
            grid-template-rows: auto 1fr auto; /* åš´æ ¼åˆ†ç‚ºä¸‰å±¤ï¼šç‹€æ…‹ã€é¡Œç›®ã€æ“ä½œ */
            gap: 10px;
            min-width: 0;
        }

        /* é ‚éƒ¨ç‹€æ…‹åˆ— */
        .status-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            background: var(--panel);
            padding: 10px;
            border-radius: 12px;
            border-bottom: 4px solid var(--sky-blue);
        }
        .stat-item { text-align: center; }
        .stat-label { font-size: 12px; color: #aaa; display: block; }
        .stat-value { font-size: 18px; font-weight: bold; color: var(--gold); }

        /* ä¸­é–“ï¼šé¡Œç›®å€ */
        .question-box {
            background: #000;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid #444;
            min-height: 0;
        }
        .q-title { color: var(--sky-blue); font-size: 2.5vh; margin-bottom: 5px; }
        #numDisplay { font-size: 12vh; font-weight: 900; color: var(--gold); line-height: 1; }
        #feedback { font-size: 3vh; font-weight: bold; margin-top: 10px; height: 4vh; }

        /* ä¸‹æ–¹ï¼šæ“ä½œå€åŸŸ */
        .interaction-area {
            display: grid;
            grid-template-columns: 1fr 180px;
            gap: 10px;
            height: 35vh; /* å›ºå®šä¸‹æ–¹é«˜åº¦ */
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 8px;
        }
        .num-btn {
            background: #3d3d3d;
            border: 2px solid #555;
            color: white;
            font-size: 3.5vh;
            font-weight: bold;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .num-btn.selected {
            background: var(--gold);
            color: #000;
            border-color: #fff;
            box-shadow: 0 0 15px var(--gold);
        }

        .control-btns {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .btn-confirm {
            flex: 2;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 4vh;
            font-weight: 900;
            box-shadow: 0 6px 0 #1e8449;
            cursor: pointer;
        }
        .btn-confirm:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-sub {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .small-action {
            background: #444;
            color: #ccc;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-cheat { color: var(--red); }

        /* å³å´æ¦œå–® */
        .side-rank {
            width: 180px;
            background: #111;
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .side-rank h3 { font-size: 16px; text-align: center; margin: 0 0 10px 0; color: var(--gold); border-bottom: 1px solid #333; padding-bottom: 5px; }
        .rank-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; font-size: 14px; }
        .rank-item { padding: 8px; border-bottom: 1px solid #222; color: #555; }
        .rank-item.active { color: #fff; background: #222; border-left: 4px solid var(--gold); }

        /* åºå¹•èˆ‡æ•…äº‹å½ˆçª— */
        .overlay { 
            position: fixed; inset: 0; background: #000; z-index: 2000; 
            display: flex; justify-content: center; align-items: center; text-align: center; padding: 20px; 
        }
        .story-card {
            background: #222; padding: 40px; border-radius: 30px; border: 4px solid var(--gold); max-width: 700px;
        }
        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98);
            z-index: 3000; padding: 20px; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #111; width: 90%; max-height: 90%; border-radius: 20px;
            padding: 30px; display: flex; flex-direction: column; border: 4px solid var(--sky-blue);
        }
        #restStory { font-size: 4vh; line-height: 1.6; overflow-y: auto; margin: 20px 0; padding: 20px; background: #050505; border-radius: 15px; }
        #restStory b { color: var(--gold); }
        #playerName { font-size: 5vh; width: 100%; padding: 15px; margin: 20px 0; text-align: center; border-radius: 10px; }
    </style>
</head>
<body>

<div id="prologue" class="overlay">
    <div class="story-card">
        <h1 style="font-size: 8vh; color: var(--gold); margin: 0 0 20px 0;">ğŸ¾ å–µå–µå¤§äº‚å…¥ï¼</h1>
        <p style="font-size: 3.5vh; line-height: 1.5; color: #eee; text-align: left;">
            ä¸å¥½äº†ï¼ç¥å¥‡æ–‡å…·åº—å‰›é€²è²¨ï¼Œ<br>
            èª¿çš®çš„å°é»‘è²“ç«Ÿç„¶è·³ä¸Šæ«ƒå°ï¼Œ<br>
            æŠŠæ‰€æœ‰çš„ã€Œåƒ¹æ ¼æ¨™ç±¤ã€éƒ½æŠ“å¾—æ»¿åœ°éƒ½æ˜¯ï¼<br><br>
            <b>å°å°åº—é•·ï¼Œå¿«ç™¼æ®ä½ çš„æ•¸å­—é­”åŠ›ï¼Œ<br>
            æŠŠæ­£ç¢ºçš„æ¨™ç±¤æ¹Šæˆå°ï¼Œé‡æ–°è²¼å›å•†å“ä¸Šå§ï¼</b>
        </p>
        <button class="btn-confirm" style="padding: 20px 60px; height: auto; margin-top: 30px;" onclick="startGame()">é–‹é–€ç‡Ÿæ¥­ ğŸ¬</button>
    </div>
</div>

<div class="app-container">
    <div class="game-main">
        <div class="status-bar">
            <div class="stat-item"><span class="stat-label">èº«ä»½</span><div class="stat-value" id="lvlStatus">å¯¦ç¿’ç”Ÿ</div></div>
            <div class="stat-item"><span class="stat-label">é€£å‹</span><div class="stat-value" id="streak">0</div></div>
            <div class="stat-item"><span class="stat-label">å¹³å‡</span><div class="stat-value" id="avgTime">0</div></div>
            <div class="stat-item"><span class="stat-label">ç›®æ¨™</span><div class="stat-value" id="lvlName" style="font-size:12px; color:var(--sky-blue)">-</div></div>
        </div>

        <div class="question-box">
            <div class="q-title">ğŸ“¦ å•†å“ç¸½åƒ¹æ ¼</div>
            <div id="numDisplay">--</div>
            <div id="feedback">READY</div>
        </div>

        <div class="interaction-area">
            <div class="number-grid" id="grid"></div>
            <div class="control-btns">
                <button class="btn-confirm" onclick="verifyPair()">ç¢ºèªæ¨™ç±¤</button>
                <div class="btn-sub">
                    <button class="small-action btn-cheat" onclick="execCheat()">å·çœ‹</button>
                    <button class="small-action" onclick="openRest()">ä¼‘æ¯</button>
                </div>
            </div>
        </div>
    </div>

    <div class="side-rank">
        <h3>ğŸ† å‚‘å‡ºåº—é•·æ¦œ</h3>
        <ul class="rank-list" id="rankList"></ul>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle" style="text-align:center; color:var(--gold); font-size: 6vh;">ğŸ“” åº—é•·ç¶“ç‡Ÿç­†è¨˜</h2>
        <div id="inputArea">
            <p style="text-align:center; font-size: 3vh;">æˆ‘æ˜¯å“ªä¸€ä½åº—é•·ï¼š</p>
            <input type="text" id="playerName" placeholder="è¼¸å…¥ä½ çš„åå­—">
        </div>
        <div id="restStory" style="display:none;"></div>
        <button class="btn-confirm" id="modalBtn" style="height: auto; padding: 20px;" onclick="confirmRest()">ç°½åå­˜æª”</button>
    </div>
</div>

<script>
    const levels = [
        { name: "æ–‡å…·å°åº—é•·", maxNum: 50, fMin: 2, fMax: 25, fast: [4, 3], slow: [8, 7] },
        { name: "ç³–æœå±‹è€é—†", maxNum: 100, fMin: 2, fMax: 50, fast: [4, 3], slow: [8, 7] },
        { name: "ç©å…·æ‰¹ç™¼å•†", maxNum: 250, fMin: 3, fMax: 80, fast: [5, 3], slow: [10, 7] },
        { name: "è¶…å¸‚ç¶“ç†", maxNum: 500, fMin: 4, fMax: 150, fast: [6, 3], slow: [12, 7] },
        { name: "é›»ç©å¤§äº¨", maxNum: 1000, fMin: 6, fMax: 250, fast: [8, 3], slow: [15, 7] },
        { name: "é£›æ©Ÿè£½é€ å•†", maxNum: 3000, fMin: 11, fMax: 500, fast: [10, 3], slow: [20, 7] },
        { name: "æ©Ÿå™¨äººå·¥å» ", maxNum: 8000, fMin: 15, fMax: 1000, fast: [12, 3], slow: [28, 7] },
        { name: "æ˜Ÿçƒè²¿æ˜“å®¶", maxNum: 25000, fMin: 21, fMax: 3000, fast: [16, 3], slow: [40, 6] },
        { name: "å®‡å®™ç¸½è£", maxNum: 100000, fMin: 51, fMax: 5000, fast: [20, 3], slow: [60, 6] }
    ];

    const heroes = ["å°å°å¯¦ç¿’ç”Ÿ", "æ­£å¼å°åº—å“¡", "å„ªç§€ç¶“ç†", "è¶…ç´šè€é—†", "é€£é–å¤§äº¨", "é»ƒé‡‘ç¸½è£", "ä¸–ç•Œç´šå•†äºº", "è²¡å¯Œä¹‹ç¥", "æ•¸å­—ä¸»å®°"];

    const stories = {
        true: [
            "ã€å°å°å¯¦ç¿’ç”Ÿã€‘{name}å¹«éš”å£å¦¹å¦¹ç®—å°æ¨™ç±¤ï¼Œå¥¹é–‹å¿ƒåœ°åˆ†çµ¦ä½ ä¸€é¡†æ°´æœç³–ï¼",
            "ã€æ­£å¼å°åº—å“¡ã€‘å°æœ‹å‹æ’éšŠæ‰¾{name}çµå¸³ï¼Œå› ç‚ºä½ ç®—å¾—æœ€æº–ï¼Œå¾ä¸æ‰¾éŒ¯éŒ¢ï¼",
            "ã€å„ªç§€ç¶“ç†ã€‘è–èª•ç¯€é‚£å¤©ï¼Œ{name}å¹«å¥½å¤šçˆ¸çˆ¸åª½åª½æŒ‘åˆ°äº†æœ€åˆ’ç®—çš„ç¦®ç‰©ï¼",
            "ã€è¶…ç´šè€é—†ã€‘{name}é–‹äº†å…¨é®æœ€å¤§çš„è¶…å¸‚ï¼Œèƒ½ä¸€çœ¼çœ‹å‡ºé€²è²¨å–®ä¸Šçš„æ•¸å­—æ¼æ´ï¼",
            "ã€é€£é–å¤§äº¨ã€‘{name}çš„åº—é–‹éå…¨åœ‹ï¼Œå¤§å®¶éƒ½å«ä½ ã€æ¨™ç±¤é”äººã€ï¼",
            "ã€é»ƒé‡‘ç¸½è£ã€‘{name}åè‘—å…¬å‹™è»Šå·¡é‚ï¼Œå¤§å®¶å«ä½ ã€æ•¸å­—å°å¤©æ‰ã€ï¼Œè¶…ç´šå¨é¢¨ï¼",
            "ã€ä¸–ç•Œç´šå•†äººã€‘å„åœ‹è€é—†éƒ½æ’éšŠç­‰è‘—è·Ÿ{name}ç°½ç´„ï¼Œå› ç‚ºä½ ç®—æ•¸æ¯”é›»è…¦å¿«ï¼",
            "ã€è²¡å¯Œä¹‹ç¥ã€‘{name}è²·ä¸‹äº†æ•´å€‹éŠæ¨‚åœ’é€çµ¦å°æœ‹å‹ï¼Œä½ æ˜¯å…¨é®çš„è‹±é›„ï¼",
            "ã€æ•¸å­—ä¸»å®°ã€‘å°{name}ä¾†èªªï¼Œæ•¸å­—æ˜¯æœ€å¥½çš„æœ‹å‹ï¼Œä½ å·²ç¶“æˆç‚ºå®‡å®™å‚³å¥‡ï¼"
        ],
        false: [
            "ã€å‡çš„å¯¦ç¿’ç”Ÿã€‘{name}æŠŠä¸€é¡†éºµåŒ…ç®—æˆä¸€ç™¾è¬ï¼Œè€é—†ç½°ä½ å­¸è²“å«ï¼Œè·¯äººéƒ½åœ¨ç¬‘ï¼",
            "ã€å‡çš„å°åº—å“¡ã€‘{name}å·çœ‹å°æŠ„ï¼Œçµæœè¢«é»‘è²“æŠ“ç ´è¤²å­ï¼Œè‡‰ç´…å¾—åƒç´…é¾æœï¼",
            "ã€å‡çš„ç¶“ç†ã€‘{name}ç®—éŒ¯åƒ¹æ ¼è®“å…¬å¸è™§éŒ¢ï¼Œè¢«è¿«ç©¿è‘—è‰è£™åœ¨é–€å£è·³èˆçµ¦äººçœ‹ï¼",
            "ã€å‡çš„è¶…ç´šè€é—†ã€‘{name}å·çœ‹è§£ç­”è¢«é»‘è²“ç™¼ç¾ï¼Œè²“æŠŠå°æŠ„è²¼åœ¨ä½ çš„è…¦é–€ä¸Šï¼",
            "ã€å‡çš„é€£é–å¤§äº¨ã€‘{name}ä½œå¼Šæ™‚æ‰‹æŒ‡è¢«å¼·åŠ›è† é»ä½ï¼Œåªèƒ½ç”¨é¼»å­é»é»è¢å¹•ï¼",
            "ã€å‡çš„é»ƒé‡‘ç¸½è£ã€‘{name}çš„å‡ç¨±è™Ÿè¢«æ­ç©¿ï¼Œåªèƒ½ç©¿è‘—ç ´è¥ªå­å»å¹«å¿™æƒå¤§è¡—ï¼",
            "ã€å‡çš„æ©Ÿå™¨äººé•·ã€‘æ©Ÿå™¨äººç®—éŒ¯æ•¸å­—ï¼Œåœ¨å·¥å» é›†é«”è·³å¤§è…¿èˆï¼Œé‚„åƒå…‰ä½ çš„åˆé¤ï¼",
            "ã€å‡çš„æ˜Ÿçƒå•†äººã€‘{name}è¢«å¤–æ˜ŸäººæŠ“å»ç«æ˜Ÿæ´—ä¸€è¬å€‹é¦¬æ¡¶ï¼Œé‚„ä¸èƒ½å¹å†·æ°£ï¼",
            "ã€å‡çš„æ•¸å­—ä¸»å®°ã€‘{name}åœ¨é›»è¦–ä¸Šç®—éŒ¯1+1ï¼Œå¤§å®¶æŠŠä½ è®Šæˆå¤§è¥¿ç“œå»æ‹è³£ï¼"
        ]
    };

    let curLvl = 0, currentTarget = 0, streak = 0, times = [], startTime, isCheated = false, selected = [], correct = [];

    function startGame() { 
        document.getElementById('prologue').style.display = 'none'; 
        generate(); 
    }

    function updateRank() {
        const list = document.getElementById('rankList');
        const p = isCheated ? "å‡çš„" : "";
        list.innerHTML = heroes.map((h, i) => `<li class="rank-item ${i === curLvl ? 'active' : ''}">${i}.${p}${h}</li>`).join('');
    }

    function generate() {
        const l = levels[curLvl];
        document.getElementById('lvlStatus').innerText = (isCheated ? "å‡çš„" : "") + heroes[curLvl];
        document.getElementById('lvlName').innerText = l.name;
        
        let found = false;
        while (!found) {
            let n = Math.floor(Math.random() * (l.maxNum - (l.maxNum/3))) + Math.floor(l.maxNum/3);
            let pairs = [];
            for (let i = l.fMin; i <= Math.sqrt(n); i++) {
                if (n % i === 0) {
                    let other = n / i;
                    if (other >= l.fMin && other <= l.fMax && i !== other) pairs.push([i, other]);
                }
            }
            if (pairs.length === 1) { currentTarget = n; correct = pairs[0]; found = true; }
        }

        let opts = [correct[0], correct[1]];
        while (opts.length < 16) {
            let f = Math.floor(Math.random() * (l.fMax - l.fMin + 1)) + l.fMin;
            if (!opts.includes(f) && currentTarget % f !== 0) opts.push(f);
        }
        opts.sort(() => Math.random() - 0.5);

        const g = document.getElementById('grid');
        g.innerHTML = ''; selected = [];
        opts.forEach(v => {
            const b = document.createElement('div');
            b.className = 'num-btn';
            b.innerText = v.toLocaleString();
            b.onclick = () => {
                if (b.classList.contains('selected')) {
                    b.classList.remove('selected');
                    selected = selected.filter(s => s !== v);
                } else if (selected.length < 2) {
                    b.classList.add('selected');
                    selected.push(v);
                }
            };
            g.appendChild(b);
        });

        document.getElementById('numDisplay').innerText = currentTarget.toLocaleString();
        document.getElementById('feedback').innerText = "ç­‰å¾…åº—é•·æ±ºç­–...";
        document.getElementById('feedback').style.color = "#888";
        startTime = Date.now();
        updateRank();
    }

    function verifyPair() {
        if (selected.length < 2) return;
        const dur = (Date.now() - startTime) / 1000;
        const ok = (selected[0] * selected[1] === currentTarget);

        if (ok) {
            streak++; times.push(dur);
            const avg = (times.reduce((a,b)=>a+b,0)/times.length).toFixed(1);
            document.getElementById('avgTime').innerText = avg + "s";
            document.getElementById('feedback').innerText = "æˆåŠŸè²¼ä¸Šæ¨™ç±¤ï¼âœ¨";
            document.getElementById('feedback').style.color = "#2ecc71";
            const l = levels[curLvl];
            if ((streak >= l.fast[1] && avg <= l.fast[0]) || (streak >= l.slow[1] && avg <= l.slow[0])) {
                setTimeout(upgrade, 400);
            } else {
                setTimeout(generate, 600);
            }
        } else {
            streak = 0; times = [];
            document.getElementById('feedback').innerText = "åƒ¹æ ¼ä¸å°å–”ï¼ğŸ’¥";
            document.getElementById('feedback').style.color = "#e74c3c";
            setTimeout(generate, 1000);
        }
        document.getElementById('streak').innerText = streak;
    }

    function execCheat() {
        isCheated = true; 
        updateRank();
        const btns = document.querySelectorAll('.num-btn');
        btns.forEach(b => { 
            const val = parseInt(b.innerText.replace(/,/g, ''));
            if(correct.includes(val)) b.classList.add('selected'); 
        });
        selected = [...correct];
        setTimeout(verifyPair, 200);
    }

    function upgrade() {
        if (curLvl < levels.length - 1) { 
            curLvl++; streak = 0; times = []; 
            alert("å“‡ï¼ä½ å‡è·äº†ï¼"); 
            generate(); 
        }
        else { alert("å¤ªå¼·äº†ï¼ä½ å·²ç¶“æ˜¯å®‡å®™æœ€å¼·å¤§äº¨ï¼"); location.reload(); }
    }

    function openRest() { document.getElementById('modal').style.display = 'flex'; }
    function confirmRest() {
        const name = document.getElementById('playerName').value || "å°åº—é•·";
        document.getElementById('inputArea').style.display = 'none';
        document.getElementById('restStory').style.display = 'block';
        document.getElementById('modalBtn').innerText = "æ˜å¤©å†è¦‹";
        document.getElementById('modalBtn').onclick = () => location.reload();
        
        let s = stories[(!isCheated).toString()][curLvl];
        document.getElementById('restStory').innerHTML = s.split("{name}").join(`<b>${name}</b>`);
    }
</script>
</body>
</html>
